services:
  testdb:
    image: postgres
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust

  testcms:
    build: .
    depends_on:
      - "testdb"
    environment:
      CMS_CONFIG: /usr/local/etc/cms-testdb.conf
      # Could be removed in the future, see:
      # - https://github.com/pytest-dev/pytest/issues/7443
      # - https://github.com/actions/runner/issues/241
      PYTEST_ADDOPTS: --color=yes
    volumes:
      - "./codecov:/home/cmsuser/cms/codecov"
    privileged: true
    cgroup: host
    command: >
      wait-for-it testdb:5432 -- sh -c "
      dropdb --host=testdb --username=postgres cmsdbfortesting ;
      createdb --host=testdb --username=postgres cmsdbfortesting ;
      cmsInitDB ;
      sudo chown cmsuser:cmsuser ./codecov ;
      pytest --cov . --cov-report xml:codecov/unittests.xml ;
      UNIT=$? ;
      dropdb --host=testdb --username=postgres cmsdbfortesting ;
      createdb --host=testdb --username=postgres cmsdbfortesting ;
      cmsInitDB ;
      cmsRunFunctionalTests -v --coverage codecov/functionaltests.xml ;
      FUNC=$? ;

      # This contraption is needed because otherwise failing unit tests aren't
      # reported in the CI as long as the functional tests are passing. Ideally
      # we should get rid of `cmsRunFunctionalTests` and make those tests work
      # with pytest so they can be auto-discovered and run in a single command.
      if [ $UNIT -ne 0 ] || [ $FUNC -ne 0 ]; then
        exit 1
      else
        exit 0
      fi
      "
